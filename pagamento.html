<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pagamento â€¢ TPG Online</title>

  <!-- Bootstrap + Tema -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
  <link rel="stylesheet" href="assets/css/theme.css">
  <link rel="stylesheet" href="assets/css/pagamento.css">

  <script src="https://sdk.mercadopago.com/js/v2"></script>

  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-XZ6RD9SGHR"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}

    // ConfiguraÃ§Ã£o padrÃ£o (sem consentimento ainda)
    gtag('consent', 'default', {
      'ad_storage': 'denied',
      'analytics_storage': 'denied'
    });

    gtag('js', new Date());
    gtag('config', 'G-XZ6RD9SGHR');
  </script>

</head>
<body>

  <!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-W2LG2C7K"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <!-- End Google Tag Manager (noscript) -->
   

  <!-- Navbar padrÃ£o -->
  <nav class="navbar navbar-expand-lg navbar-dark tpg sticky-top">
    <div class="container">
      <a class="navbar-brand" href="index.html">TPG<span>Online</span></a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="mainNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item"><a class="nav-link" href="index.html">InÃ­cio</a></li>
          <li class="nav-item"><a class="nav-link" href="cnpj.html">Consultar CNPJ</a></li>
          <li class="nav-item"><a class="nav-link" href="cep.html">Consultar CEP</a></li>
          <li class="nav-item"><a class="nav-link" href="ncm.html">Consultar NCM</a></li>
          <li class="nav-item"><a class="nav-link" href="fipe.html">Consultar FIPE</a></li>
          <li class="nav-item"><a class="nav-link " href="qrcode.html">Gerar QR Code</a></li>
          <li class="nav-item"><a class="nav-link active" href="pagamento.html">Pagamento</a></li>
          <li class="nav-item"><a class="nav-link " href="calculadora-imc.html">Calculadora IMC</a></li>
          <li class="nav-item"><a class="nav-link" href="https://f4e38d4c63c0.ngrok-free.app/ngl/frontend/login.html">Login</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- ConteÃºdo central -->
  <main>
    <div id="pagamento-box">
      <h2>Ajude a manter o TPG Online ğŸ’™</h2>
      <p class="info">
        Nosso site Ã© totalmente gratuito. Ao colaborar com um valor simbÃ³lico de <b>R$ 1,99</b>,
        vocÃª ajuda a manter o servidor online e o projeto ativo. ğŸ™Œ
      </p>
  
      <!-- Barra de carregamento -->
      <div class="progress-bar">
        <div class="progress-fill" style="width: 30%;"></div>
      </div>
  
      <button id="btnPagar" class="btn">
        <img src="https://logodownload.org/wp-content/uploads/2019/06/mercado-pago-logo.png"
             alt="Mercado Pago" style="height: 26px; width: auto; filter: brightness(10);">
        <span>Pagar com Mercado Pago</span>
      </button>
  
      <div id="statusMsg"></div>
    </div>
  </main>
  

  <!-- RodapÃ© -->
  <footer class="site-footer py-4 mt-5">
    <div class="container text-center small">
      Â© <span id="year"></span> TPG Online Â· 
      <a href="privacy.html">Privacidade</a> Â· 
      <a href="terms.html">Termos</a> Â· 
      <a href="cookies.html">Cookies</a>
    </div>
  </footer>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
  <script src="assets/js/pagamento.js"></script>

  <script>
    document.getElementById('year').textContent = new Date().getFullYear();

    async function verificarStatusPagamento() {
      const urlParams = new URLSearchParams(window.location.search);
      const paymentId = urlParams.get("payment_id");
      const fallbackId = localStorage.getItem("preference_id");
      const idParaVerificar = paymentId || fallbackId;

      if (!idParaVerificar) return;

      document.getElementById("statusMsg").innerHTML = "ğŸ”„ Verificando pagamento...";
      try {
        const res = await fetch(`/.netlify/functions/verificar_pagamento?id=${idParaVerificar}`);
        const data = await res.json();

        if (data.status === "approved") {
          document.getElementById("statusMsg").innerHTML = "âœ… Pagamento aprovado! Redirecionando...";
          localStorage.removeItem("preference_id");
          setTimeout(() => window.location.href = "https://tpgonline.com.br/index.html", 2000);
        } else if (["pending", "in_process"].includes(data.status)) {
          document.getElementById("statusMsg").innerHTML = "âŒ› Pagamento pendente. Aguarde alguns segundos e atualize a pÃ¡gina.";
        } else {
          document.getElementById("statusMsg").innerHTML = "ğŸ’¬ Ainda nÃ£o encontramos o pagamento. Tente novamente em alguns minutos.";
        }
      } catch (err) {
        document.getElementById("statusMsg").innerHTML = "âš ï¸ Erro ao verificar pagamento. Tente novamente mais tarde.";
      }
    }

    verificarStatusPagamento();
  </script>
</body>
</html>
