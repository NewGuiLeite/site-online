<script src="assets/js/pagamento.js"></script>

<script>
async function verificarStatusPagamento() {
  // 1Ô∏è‚É£ Tenta primeiro capturar o payment_id da URL
  const urlParams = new URLSearchParams(window.location.search);
  const paymentId = urlParams.get("payment_id");

  // 2Ô∏è‚É£ Se n√£o tiver, usa o preference_id salvo no localStorage (caso a volta n√£o traga o payment_id)
  const fallbackId = localStorage.getItem("preference_id");
  const idParaVerificar = paymentId || fallbackId;

  if (!idParaVerificar) {
    console.log("Nenhum ID encontrado para verificar.");
    return;
  }

  try {
    document.getElementById("statusMsg").innerHTML = "üîÑ Verificando pagamento...";

    const res = await fetch(`/.netlify/functions/verificar_pagamento?id=${idParaVerificar}`);
    const data = await res.json();

    console.log("üîé Resposta da verifica√ß√£o:", data);

    if (data.status === "approved") {
      document.getElementById("statusMsg").innerHTML = "‚úÖ Pagamento aprovado! Redirecionando...";
      localStorage.removeItem("preference_id");

      // Redireciona para o certificado ap√≥s 2 segundos
      setTimeout(() => {
        window.location.href = "https://tpgonline.com.br/certificado.html";
      }, 2000);
    } else if (data.status === "pending" || data.status === "in_process") {
      document.getElementById("statusMsg").innerHTML =
        "‚åõ Pagamento pendente. Aguarde alguns segundos e atualize a p√°gina.";
    } else {
      document.getElementById("statusMsg").innerHTML =
        "üí¨ Ainda n√£o encontramos o pagamento. Tente novamente em alguns minutos.";
    }
  } catch (err) {
    console.error("‚ùå Erro ao verificar pagamento:", err);
    document.getElementById("statusMsg").innerHTML =
      "‚ö†Ô∏è Erro ao verificar pagamento. Tente novamente mais tarde.";
  }
}

// Executa automaticamente ao abrir a p√°gina
verificarStatusPagamento();
</script>
